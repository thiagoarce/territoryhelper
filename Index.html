<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/@geoman-io/leaflet-geoman-free@latest/dist/leaflet-geoman.css" />
    <?!= include('Styles'); ?>
  </head>
  <body>

    <div id="loading" class="loading-overlay">
      <div class="spinner-border text-primary"></div>
      <p class="mt-2 fw-bold text-secondary" id="loadingText">Carregando...</p>
    </div>

    <div id="telaGeral" class="screen active container-fluid py-3">
      <h5 class="fw-bold mb-3"><i class="fa-solid fa-earth-americas text-primary me-2"></i>Visão Geral</h5>
      <div class="row g-2 mb-3">
        <div class="col-6"><div class="stat-card"><h3 class="fw-bold text-primary m-0" id="totalQuadrasGeral">-</h3><small>Quadras</small></div></div>
        <div class="col-6"><div class="stat-card"><h3 class="fw-bold text-success m-0" id="totalDomiciliosGeral">-</h3><small>Domicílios</small></div></div>
      </div>
      <div class="map-wrapper position-relative">
        <div id="mapGeral"></div>
        <div class="btn-gps" onclick="ativarGPS('geral')"><i class="fa-solid fa-location-crosshairs"></i></div>
      </div>
    </div>

    <div id="telaPoligonos" class="screen container-fluid py-3">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 class="fw-bold m-0"><i class="fa-solid fa-pen-to-square text-info me-2"></i>Editor</h5>
        <button class="btn btn-sm btn-outline-secondary" onclick="iniciarMapaPoligonos()"><i class="fa-solid fa-rotate-right"></i></button>
      </div>
      <div class="filter-bar">
        <select class="form-select form-select-sm w-auto" onchange="mudarVisualizacao(this.value)">
          <option value="both">Tudo</option><option value="quadras">Quadras</option><option value="territorios" selected>Territórios</option>
        </select>
        <div class="form-check form-switch ms-2"><input class="form-check-input" type="checkbox" id="toggleNumbers" checked onchange="toggleNumerosTerritorios(this.checked)"><label class="form-check-label small">Nomes</label></div>
        <div class="form-check form-switch ms-2"><input class="form-check-input" type="checkbox" id="toggleOptionalLabels" onchange="toggleOptionalLabels(this.checked)"><label class="form-check-label small text-secondary">Opcionais</label></div>
      </div>
      <div class="tools-bar">
        <div class="d-flex justify-content-between align-items-center mb-2">
           <div class="form-check form-switch"><input class="form-check-input" type="checkbox" id="toggleSelectionMode" onchange="alternarModoSelecao(this.checked)"><label class="form-check-label small fw-bold">Seleção Múltipla</label></div>
           <span class="badge bg-secondary" id="countSelectedBadge">0</span>
        </div>
        <div id="divEditandoTerritorio" class="d-none mb-2 p-1 bg-warning bg-opacity-25 rounded border border-warning">
           <p class="small fw-bold mb-1 text-center">Editando: <span id="lblEditandoNome"></span></p>
           <button class="btn btn-sm btn-warning w-100 fw-bold" onclick="salvarRevisaoTerritorio()"><i class="fa-solid fa-check"></i> Confirmar</button>
        </div>
        <div class="d-flex gap-2" id="barraBotoesPadrao">
          <button id="btnSalvarTerritorio" class="btn btn-sm btn-success flex-fill disabled" onclick="abrirModalSalvarTerritorio()"><i class="fa-solid fa-layer-group"></i> Território</button>
          <button id="btnJuntarQuadras" class="btn btn-sm btn-primary flex-fill disabled" onclick="iniciarFusaoQuadras()"><i class="fa-solid fa-object-group"></i> Juntar</button>
        </div>
      </div>
      <p class="text-muted small mb-1" id="msgHelp">Ative a seleção ou clique para editar.</p>
      <div class="map-wrapper position-relative">
        <div id="mapPoligonos"></div>
        <div class="btn-gps" onclick="ativarGPS('editor')"><i class="fa-solid fa-location-crosshairs"></i></div>
      </div>
    </div>

    <div id="telaRegistro" class="screen container-fluid py-3">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="fw-bold m-0"><i class="fa-solid fa-clipboard-check text-success me-2"></i>Registro</h5>
        <button class="btn btn-sm btn-outline-secondary" onclick="carregarDadosRegistro()"><i class="fa-solid fa-rotate"></i></button>
      </div>
      
      <div class="sticky-action-bar">
        <div class="d-flex gap-2 align-items-end">
          <div class="flex-grow-1"><label class="small text-muted fw-bold">Data Conclusão</label><input type="date" class="form-control form-control-sm" id="dataRegistro"></div>
          <button class="btn btn-success btn-sm fw-bold" onclick="salvarConclusao()"><i class="fa-solid fa-check"></i> Concluir</button>
        </div>
        <div class="mt-2 d-flex justify-content-between">
           <small class="text-muted"><span id="countRegistro">0</span> selecionados</small>
           <div class="small text-muted" style="font-size: 0.7rem;">
             <i class="fa-solid fa-circle-check text-success"></i> <15d |
             <i class="fa-solid fa-circle-check text-secondary"></i> <2m | 
             <i class="fa-solid fa-circle-exclamation text-danger"></i> >4m
           </div>
        </div>
      </div>

      <div class="map-wrapper position-relative">
        <div id="mapRegistro"></div>
        <div class="btn-gps" onclick="ativarGPS('registro')"><i class="fa-solid fa-location-crosshairs"></i></div>
      </div>
    </div>

    <div id="telaDetalhe" class="screen container-fluid py-3">
      <div class="d-flex gap-2 mb-3 no-print">
        <select id="selectQuadra" class="form-select shadow-sm" onchange="carregarQuadra(this.value)"><option value="" selected disabled>Selecione...</option></select>
        <button class="btn btn-outline-secondary" onclick="window.print()"><i class="fa-solid fa-print"></i></button>
      </div>
      <div id="infoArea" style="display:none;">
        <div class="d-flex justify-content-between align-items-start mb-2">
           <div><h4 id="tituloQuadra" class="fw-bold text-dark mb-1"></h4><p class="text-muted small mb-0"><span id="totalEnderecos">0</span> Endereços</p></div>
           <button class="btn btn-primary btn-sm" id="btnRotaDetalhe" style="display:none"><i class="fa-solid fa-diamond-turn-right"></i> Rota</button>
        </div>
        <div id="mapDetalhe"></div>
        <div class="accordion pb-5" id="listaEnderecos"></div>
      </div>
    </div>

    <div class="modal fade" id="modalEdicao" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Quadra</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form><input type="hidden" id="editOriginalId"><div class="d-flex justify-content-end mb-3"><button type="button" class="btn btn-sm btn-warning" onclick="iniciarDivisaoPorVertices()">Dividir</button></div><div class="mb-3"><label>ID</label><input type="text" class="form-control" id="editId"></div><div class="mb-3"><label>Território</label><input type="text" class="form-control" id="editTerritory"></div><div class="mb-3"><label>Cor</label><input type="color" class="form-control w-100" id="editColor"></div><button type="button" class="btn btn-outline-primary w-100" id="btnToggleVertex" onclick="ativarEdicaoVertices()">Editar Vértices</button></form></div><div class="modal-footer justify-content-between"><button class="btn btn-danger" onclick="deletarQuadraAtual()">Excluir</button><button class="btn btn-primary" onclick="salvarQuadraAtual()">Salvar</button></div></div></div></div>
    <div class="modal fade" id="modalNovoTerritorio" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header bg-success text-white"><h5 class="modal-title">Novo Território</h5></div><div class="modal-body"><p>Quadras: <b id="lblCountTerritorio">0</b></p><div class="mb-3"><label>Nome</label><input type="text" class="form-control" id="newTerritoryName"></div><div class="mb-3"><label>Cor</label><input type="color" class="form-control w-100" id="newTerritoryColor" value="#ffeb3b"></div><div class="mb-3"><label>Rótulo</label><select class="form-select" id="newTerritoryLabelType"><option value="visible">Visível</option><option value="optional">Opcional</option></select></div></div><div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button><button class="btn btn-success" onclick="confirmarSalvarTerritorio()">Criar</button></div></div></div></div>
    <div class="modal fade" id="modalEditarTerritorio" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header bg-warning"><h5 class="modal-title">Editar Território</h5></div><div class="modal-body"><input type="hidden" id="editTerrOriginalName"><div class="mb-3"><label>Nome</label><input type="text" class="form-control" id="editTerrName"></div><div class="mb-3"><label>Cor</label><input type="color" class="form-control w-100" id="editTerrColor"></div><div class="mb-3"><label>Rótulo</label><select class="form-select" id="editTerrLabelType"><option value="visible">Visível</option><option value="optional">Opcional</option></select></div><hr><button class="btn btn-outline-dark w-100" onclick="iniciarSelecaoTerritorioExistente()">Adicionar/Remover Quadras</button></div><div class="modal-footer justify-content-between"><button class="btn btn-danger" onclick="deletarTerritorioAtual()">Excluir</button><button class="btn btn-primary" onclick="salvarTerritorioExistente()">Salvar</button></div></div></div></div>
    <div class="modal fade" id="modalNomear" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header bg-primary text-white"><h5 class="modal-title" id="lblTituloNomear">Nomear</h5></div><div class="modal-body"><div id="containerInputsNomes"></div></div><div class="modal-footer"><button class="btn btn-secondary" onclick="cancelarOperacaoGeometrica()" data-bs-dismiss="modal">Cancelar</button><button class="btn btn-primary" onclick="confirmarOperacaoGeometrica()">Salvar</button></div></div></div></div>

    <div class="bottom-nav">
      <div class="nav-item active" onclick="mudarAba('geral')" id="btnAbaGeral"><i class="fa-solid fa-map-location-dot"></i><span>Geral</span></div>
      <div class="nav-item" onclick="mudarAba('poligonos')" id="btnAbaPoligonos"><i class="fa-solid fa-pen-ruler"></i><span>Editor</span></div>
      <div class="nav-item" onclick="mudarAba('registro')" id="btnAbaRegistro"><i class="fa-solid fa-check-double"></i><span>Registro</span></div>
      <div class="nav-item" onclick="mudarAba('detalhe')" id="btnAbaDetalhe"><i class="fa-solid fa-list-check"></i><span>Detalhes</span></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/@geoman-io/leaflet-geoman-free@latest/dist/leaflet-geoman.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
    <?!= include('JS-Mapas'); ?>
    <?!= include('JS-App'); ?>
  </body>
</html>