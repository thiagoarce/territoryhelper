<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/@geoman-io/leaflet-geoman-free@latest/dist/leaflet-geoman.css" />
    <?!= include('CSS'); ?>
  </head>
  <body>
    <div id="loading" class="loading-overlay"><div class="spinner-border text-primary"></div><p class="mt-2 fw-bold text-secondary" id="loadingText">Carregando...</p></div>

    <div id="telaGeral" class="screen active container-fluid py-3">
      <h5 class="fw-bold mb-3"><i class="fa-solid fa-map-location-dot text-primary me-2"></i>Visão Geral</h5>
      <div class="filter-bar mb-2 d-flex gap-3 justify-content-center bg-white p-2 border rounded shadow-sm">
        <div class="form-check form-switch"><input class="form-check-input" type="checkbox" id="checkGeralQuadras" checked onchange="window.toggleCamadasGeral()"><label class="form-check-label small fw-bold">Quadras</label></div>
        <div class="form-check form-switch"><input class="form-check-input" type="checkbox" id="checkGeralTerritorios" onchange="window.toggleCamadasGeral()"><label class="form-check-label small fw-bold">Territórios</label></div>
      </div>
      <div id="barraCompartilhar" class="alert alert-info py-2 d-none d-flex justify-content-between align-items-center">
         <span class="small fw-bold"><span id="countShare">0</span> quadra(s) selecionada(s)</span>
         <button class="btn btn-sm btn-primary" onclick="window.gerarLinkPublico()"><i class="fa-solid fa-share-nodes"></i> Compartilhar</button>
      </div>
      <div class="map-wrapper position-relative"><div id="mapGeral"></div><div class="btn-gps" onclick="window.ativarGPS('geral')"><i class="fa-solid fa-location-crosshairs"></i></div></div>
      <div class="mt-2 text-center text-muted small">Clique nas quadras para selecionar e compartilhar.</div>
    </div>

    <div id="telaPoligonos" class="screen container-fluid py-3">
      <h5 class="fw-bold mb-2"><i class="fa-solid fa-pen-ruler text-info me-2"></i>Editor</h5>
      <div class="filter-bar d-flex flex-wrap align-items-center gap-3 mb-2 justify-content-center">
        <select id="editorViewSelect" class="form-select form-select-sm w-auto border-secondary" onchange="window.mudarVisualizacao(this.value)"><option value="quadras">Quadras</option><option value="territorios">Territórios</option><option value="both" selected>Ambos</option></select>
        <div class="d-flex gap-3 bg-light px-2 py-1 rounded border">
            <div class="form-check form-switch m-0"><input class="form-check-input" type="checkbox" id="toggleFacesRes" onchange="window.renderizarFaces()"><label class="small text-primary fw-bold">Dom</label></div>
            <div class="form-check form-switch m-0"><input class="form-check-input" type="checkbox" id="toggleFacesCom" onchange="window.renderizarFaces()"><label class="small text-warning fw-bold">Com</label></div>
        </div>
        <div class="form-check form-switch ms-1"><input class="form-check-input" type="checkbox" id="toggleNumbers" checked onchange="window.toggleNumerosTerritorios(this.checked)"><label class="small text-muted">Rótulos</label></div>
      </div>
      <div id="barraAssociacao" class="d-none w-100 mb-2"><button id="btnAssociarFaces" class="btn btn-sm btn-dark w-100 shadow-sm" style="border-style: dashed; border-width: 2px;" disabled>Selecione faces...</button></div>
      <div class="tools-bar">
        <div class="d-flex justify-content-between align-items-center mb-2 w-100">
           <div class="form-check form-switch"><input class="form-check-input" type="checkbox" id="toggleSelectionMode" onchange="window.alternarModoSelecao(this.checked)"><label class="small fw-bold">Seleção Múltipla</label></div>
           <span class="badge bg-primary" id="countSelectedBadge">0</span>
        </div>
        <div id="divEditandoTerritorio" class="d-none mb-2 p-1 bg-warning bg-opacity-25 rounded border border-warning w-100">
           <p class="small fw-bold mb-1 text-center">Editando: <span id="lblEditandoNome"></span></p>
           <button class="btn btn-sm btn-warning w-100 fw-bold" onclick="window.salvarRevisaoTerritorio()"><i class="fa-solid fa-check"></i> Confirmar</button>
        </div>
        <div class="d-flex gap-2 w-100" id="barraBotoesPadrao">
          <button id="btnSalvarTerritorio" class="btn btn-sm btn-success flex-fill disabled" onclick="window.abrirModalSalvarTerritorio()">Território</button>
          <button id="btnJuntarQuadras" class="btn btn-sm btn-primary flex-fill disabled" onclick="window.iniciarFusaoQuadras()">Juntar</button>
        </div>
      </div>
      <div class="map-wrapper position-relative"><div id="mapPoligonos"></div></div>
    </div>

    <div id="telaRegistro" class="screen container-fluid py-3">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 class="fw-bold m-0 text-success"><i class="fa-solid fa-clipboard-check me-2"></i>Registro</h5>
        <div class="form-check form-switch"><input class="form-check-input" type="checkbox" id="toggleLabelsRegistro" onchange="window.toggleLabelsRegistro(this.checked)"><label class="small fw-bold">Ver Nomes</label></div>
      </div>
      <div class="sticky-action-bar mb-2">
        <div class="d-flex gap-2 align-items-end">
          <div class="flex-grow-1"><input type="date" class="form-control form-control-sm" id="dataRegistro"></div>
          <button class="btn btn-success btn-sm fw-bold position-relative" onclick="window.iniciarSalvamentoConclusao()">Concluir</button>
        </div>
        <div class="mt-1 d-flex justify-content-between align-items-center flex-wrap gap-2 text-muted small" style="font-size: 0.7rem;">
           <span><i class="fa-solid fa-circle-check text-success"></i> <15d</span><span><i class="fa-solid fa-circle-check" style="color:#81c784"></i> <30d</span><span><i class="fa-solid fa-circle-check text-warning"></i> 2m</span><span><i class="fa-solid fa-triangle-exclamation text-danger"></i> >3m</span>
        </div>
      </div>
      <div class="map-wrapper position-relative"><div id="mapRegistro"></div><div class="btn-gps" onclick="window.ativarGPS('registro')"><i class="fa-solid fa-location-crosshairs"></i></div></div>
    </div>

    <div class="modal fade" id="modalEdicao" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Quadra</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form><input type="hidden" id="editOriginalId"><div class="d-flex justify-content-end mb-3"><button type="button" class="btn btn-sm btn-warning" onclick="window.iniciarDivisaoPorVertices()">Dividir</button></div><div class="mb-3"><label>ID</label><input type="text" class="form-control" id="editId"></div><div class="mb-3"><label>Território</label><input type="text" class="form-control" id="editTerritory"></div><div class="mb-3"><label>Cor</label><input type="color" class="form-control w-100" id="editColor"></div><button type="button" class="btn btn-outline-primary w-100" id="btnToggleVertex" onclick="window.ativarEdicaoVertices()">Editar Vértices</button></form></div><div class="modal-footer justify-content-between"><button class="btn btn-danger" onclick="window.deletarQuadraAtual()">Excluir</button><button class="btn btn-primary" onclick="window.salvarQuadraAtual()">Salvar</button></div></div></div></div>
    <div class="modal fade" id="modalNovoTerritorio" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header bg-success text-white"><h5 class="modal-title">Novo Território</h5></div><div class="modal-body"><p>Quadras: <b id="lblCountTerritorio">0</b></p><div class="mb-3"><label>Nome</label><input type="text" class="form-control" id="newTerritoryName"></div><div class="mb-3"><label>Cor</label><input type="color" class="form-control w-100" id="newTerritoryColor" value="#ffeb3b"></div><div class="mb-3"><label>Rótulo</label><select class="form-select" id="newTerritoryLabelType"><option value="visible">Visível</option><option value="optional">Opcional</option></select></div></div><div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button><button class="btn btn-success" onclick="window.confirmarSalvarTerritorio()">Criar</button></div></div></div></div>
    
    <div class="modal fade" id="modalEditarTerritorio" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header bg-warning"><h5 class="modal-title">Editar Território</h5></div><div class="modal-body"><input type="hidden" id="editTerrOriginalName"><div class="mb-3"><label>Nome</label><input type="text" class="form-control" id="editTerrName"></div><div class="mb-3"><label>Cor</label><input type="color" class="form-control w-100" id="editTerrColor"></div><div class="mb-3"><label>Rótulo</label><select class="form-select" id="editTerrLabelType"><option value="visible">Visível</option><option value="optional">Opcional</option></select></div><hr><div class="d-grid gap-2"><button class="btn btn-outline-dark" onclick="window.iniciarSelecaoTerritorioExistente()">Adicionar/Remover Quadras</button><button class="btn btn-outline-primary" onclick="window.editarPoligonoManual()">Editar Polígono Manualmente</button></div></div><div class="modal-footer justify-content-between"><button class="btn btn-danger" onclick="window.deletarTerritorioAtual()">Excluir</button><button class="btn btn-primary" onclick="window.salvarTerritorioExistente()">Salvar</button></div></div></div></div>

    <div class="modal fade" id="modalNomear" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header bg-primary text-white"><h5 class="modal-title" id="lblTituloNomear">Nomear</h5></div><div class="modal-body"><div id="containerInputsNomes"></div></div><div class="modal-footer"><button class="btn btn-secondary" onclick="window.cancelarOperacaoGeometrica()" data-bs-dismiss="modal">Cancelar</button><button class="btn btn-primary" onclick="window.confirmarOperacaoGeometrica()">Salvar</button></div></div></div></div>
    <div class="modal fade" id="modalConflitoData" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header bg-warning"><h5 class="modal-title">Data Antiga</h5></div><div class="modal-body"><p>Data anterior. O que fazer?</p><div class="d-grid gap-2"><button class="btn btn-primary" onclick="window.resolverConflito('substituir')">Substituir</button><button class="btn btn-outline-secondary" onclick="window.resolverConflito('apenas_historico')">Apenas Histórico</button></div></div></div></div></div>

    <div class="modal fade" id="modalLinkPublico" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Link para Publicador</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body text-center"><p>Copie o link abaixo e envie ao publicador:</p><div class="input-group"><input type="text" class="form-control" id="inputLinkPublico" readonly><button class="btn btn-outline-secondary" onclick="navigator.clipboard.writeText(document.getElementById('inputLinkPublico').value);alert('Copiado!')"><i class="fa-regular fa-copy"></i></button></div><br><small class="text-muted">Apenas quadras do território <b><span id="lblTerritorioShare"></span></b>.</small></div></div></div></div>

    <div class="bottom-nav">
      <div class="nav-item active" onclick="window.mudarAba('geral')" id="btnAbaGeral"><i class="fa-solid fa-house-chimney"></i><span>Geral</span></div>
      <div class="nav-item" onclick="window.mudarAba('poligonos')" id="btnAbaPoligonos"><i class="fa-solid fa-pen-ruler"></i><span>Editor</span></div>
      <div class="nav-item" onclick="window.mudarAba('registro')" id="btnAbaRegistro"><i class="fa-solid fa-clipboard-check"></i><span>Registro</span></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/@geoman-io/leaflet-geoman-free@latest/dist/leaflet-geoman.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
    <?!= include('JS_App'); ?>
  </body>
</html>