<script>
  window.isSelectionMode = false;
  window.selectedQuadras = [];
  let layerUserLocation = null;
  let showTerritoryNumbers = true;
  let showOptionalLabels = false;

  // Mapa Geral, Editor e Registro
  let mapGeral, mapPoligonos, mapDetalhe, mapRegistro;
  let layerGroupQuadras, layerGroupTerritorios, layerGroupTerritoryLabels, layerGroupVerticesTemp;
  
  // Layer específico do Registro
  let layerGroupRegistro = null; 
  let layerGroupRegistroIcons = null;
  
  let verticesSelecionados = [];

  // --- MAPA GERAL ---
  function carregarMapaGeral() {
    google.script.run.withSuccessHandler(dados => {
      document.getElementById('totalQuadrasGeral').innerText = dados.length;
      document.getElementById('totalDomiciliosGeral').innerText = dados.reduce((acc, c) => acc + c.total, 0);
      if(!mapGeral) { 
        mapGeral = L.map('mapGeral').setView([-7.115, -34.863], 13); 
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mapGeral); 
      }
      dados.forEach(q => { 
        if(q.lat && q.lng) { 
          L.marker([q.lat, q.lng]).addTo(mapGeral).bindPopup(
            '<div class="text-center"><h6>' + q.id + '</h6><p>' + q.total + ' Domicílios</p>' +
            '<button class="btn btn-sm btn-primary w-100 mb-1" onclick="irParaDetalhes(\'' + q.id + '\')">Ver Detalhes</button>' +
            '<button class="btn btn-sm btn-outline-success w-100" onclick="abrirRota(' + q.lat + ', ' + q.lng + ')"><i class="fa-solid fa-diamond-turn-right"></i> Rota</button></div>'); 
        } 
      });
      showLoading(false);
    }).getVisaoGeral();
  }

  // --- MAPA EDITOR ---
  function iniciarMapaPoligonos() {
    if (!mapPoligonos) {
      mapPoligonos = L.map('mapPoligonos').setView([-7.115, -34.863], 14);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mapPoligonos);
      mapPoligonos.pm.setGlobalOptions({ allowSelfIntersection: false });
      layerGroupQuadras = L.featureGroup().addTo(mapPoligonos);
      layerGroupTerritorios = L.featureGroup().addTo(mapPoligonos);
      layerGroupTerritoryLabels = L.featureGroup().addTo(mapPoligonos);
      layerGroupVerticesTemp = L.featureGroup().addTo(mapPoligonos);
    }
    carregarDadosEditor();
  }
  function carregarDadosEditor() {
    showLoading(true, "Carregando...");
    layerGroupQuadras.clearLayers(); layerGroupTerritorios.clearLayers(); layerGroupTerritoryLabels.clearLayers();
    limparSelecao();
    google.script.run.withSuccessHandler(dados => {
      dados.forEach(d => {
        if (d.polyString.length > 5) {
          const latlngs = d.polyString.split(" | ").map(p => { const c = p.split(","); return [parseFloat(c[0]), parseFloat(c[1])]; });
          const poly = L.polygon(latlngs, { color: d.color, fillColor: d.color, fillOpacity: 0.3, weight: 1, color: '#666' });
          poly.metaData = d;
          const c = poly.getBounds().getCenter();
          poly.bindPopup('<div class="text-center"><b>' + d.id + '</b><br><button class="btn btn-sm btn-success mt-1" onclick="abrirRota(' + c.lat + ', ' + c.lng + ')">Rota</button></div>');
          poly.on('click', function() { if (window.isSelectionMode) toggleSelecaoQuadra(this); else abrirModalEdicao(this); });
          layerGroupQuadras.addLayer(poly);
        }
      });
      carregarTerritorios();
    }).getPoligonosQuadras();
  }
  function carregarTerritorios() {
    google.script.run.withSuccessHandler(dados => {
      dados.forEach(t => {
        if (t.polyString.length > 5) {
          const latlngs = t.polyString.split(" | ").map(p => { const c = p.split(","); return [parseFloat(c[0]), parseFloat(c[1])]; });
          const poly = L.polygon(latlngs, { color: t.color, weight: 2, fillColor: t.color, fillOpacity: 0.5 });
          poly.metaData = t;
          poly.on('click', function() { if (!window.isSelectionMode) abrirModalEditarTerritorio(this.metaData); });
          layerGroupTerritorios.addLayer(poly);
          let centro;
          if (t.labelPos && t.labelPos.includes(",")) { const p = t.labelPos.split(","); centro = [parseFloat(p[0]), parseFloat(p[1])]; } 
          else { centro = poly.getBounds().getCenter(); }
          const icon = L.divIcon({ className: '', html: '<div class="territory-badge">' + formatarTextoBadge(t.name) + '</div>', iconSize: [0, 0] });
          const marker = L.marker(centro, { icon: icon, draggable: false });
          marker.metaData = { territoryName: t.name, labelType: t.labelType };
          layerGroupTerritoryLabels.addLayer(marker);
        }
      });
      atualizarVisibilidadeLabels();
      mudarVisualizacao("territorios");
      showLoading(false);
    }).getDadosTerritorios();
  }

  // --- MAPA REGISTRO (NOVO) ---
  function iniciarMapaRegistro(dadosQuadras) {
    if (!mapRegistro) {
      mapRegistro = L.map('mapRegistro').setView([-7.115, -34.863], 14);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mapRegistro);
      layerGroupRegistro = L.featureGroup().addTo(mapRegistro);
      layerGroupRegistroIcons = L.featureGroup().addTo(mapRegistro);
    }
    
    // Limpar
    layerGroupRegistro.clearLayers();
    layerGroupRegistroIcons.clearLayers();
    
    const hoje = new Date();
    
    dadosQuadras.forEach(q => {
      if (q.polyString && q.polyString.length > 5) {
        const latlngs = q.polyString.split(" | ").map(p => { const c = p.split(","); return [parseFloat(c[0]), parseFloat(c[1])]; });
        
        // Polígono Básico
        const poly = L.polygon(latlngs, { color: q.color, fillColor: q.color, fillOpacity: 0.4, weight: 1 });
        poly.metaData = q; // Guardar ID
        
        // Evento de Clique para Selecionar
        poly.on('click', function() { toggleSelecaoRegistro(this); });
        
        layerGroupRegistro.addLayer(poly);

        // Lógica de Ícones baseada na Data
        if (q.status === 'Concluído' && q.dataConclusao) {
           // Converter YYYY-MM-DD para Date
           const parts = q.dataConclusao.split('-');
           const dataConc = new Date(parts[0], parts[1]-1, parts[2]);
           const diffTime = Math.abs(hoje - dataConc);
           const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
           
           let iconClass = "";
           let iconHtml = "";
           
           if (diffDays <= 14) {
             // Verde (Recente)
             iconClass = "status-ok-recent";
             iconHtml = '<i class="fa-solid fa-circle-check"></i>';
           } else if (diffDays <= 60) {
             // Cinza (Médio)
             iconClass = "status-ok-old";
             iconHtml = '<i class="fa-solid fa-circle-check"></i>';
           } else if (diffDays <= 120) {
             // Nada (Esfriando) - Não poe icone
           } else {
             // Exclamação (Vencido > 4 meses)
             iconClass = "status-alert";
             iconHtml = '<i class="fa-solid fa-circle-exclamation"></i>';
           }
           
           if (iconHtml) {
             const center = poly.getBounds().getCenter();
             const divIcon = L.divIcon({ 
               className: 'status-marker-icon ' + iconClass, 
               html: iconHtml, 
               iconSize: [20, 20],
               iconAnchor: [10, 10] // Centro do icone
             });
             const marker = L.marker(center, { icon: divIcon, interactive: false });
             layerGroupRegistroIcons.addLayer(marker);
           }
        }
      }
    });
  }

  function toggleSelecaoRegistro(layer) {
    // Função chamada pelo JS-App via toggleRegGlobal, mas aqui tratamos visual
    // Vamos chamar o JS-App para gerenciar o Set de IDs e atualizar o contador
    toggleReg(layer.metaData.id); // Chama JS-App
    
    // Atualiza visual
    if (registroSelecionados.has(layer.metaData.id)) {
       layer.setStyle({ color: 'red', weight: 3, opacity: 1, fillOpacity: 0.6 });
    } else {
       layer.setStyle({ color: layer.metaData.color, weight: 1, opacity: 1, fillOpacity: 0.4 });
    }
  }

  // --- GPS E ROTA ---
  function ativarGPS(tela) {
    let mapa;
    if (tela === 'geral') mapa = mapGeral;
    else if (tela === 'editor') mapa = mapPoligonos;
    else if (tela === 'registro') mapa = mapRegistro;
    
    if(!mapa) return;
    mapa.locate({setView: true, maxZoom: 16, enableHighAccuracy: true});
    mapa.once('locationfound', e => {
       if(layerUserLocation) mapa.removeLayer(layerUserLocation);
       layerUserLocation = L.layerGroup().addTo(mapa);
       L.circle(e.latlng, { radius: e.accuracy/2, color: '#136AEC', fillOpacity: 0.1 }).addTo(layerUserLocation);
       L.circleMarker(e.latlng, { radius: 8, fillColor: '#2A93EE', color: 'white', fillOpacity: 1 }).bindPopup("Você").addTo(layerUserLocation);
    });
    mapa.once('locationerror', () => alert("GPS não acessível."));
  }
  function abrirRota(lat, lng) {
    const url = "https://www.google.com/maps/dir/?api=1&destination=" + lat + "," + lng + "&travelmode=walking";
    window.open(url, '_blank');
  }

  // --- AUXILIARES ---
  function mudarVisualizacao(modo) {
    if(!mapPoligonos) return;
    layerGroupQuadras.remove(); layerGroupTerritorios.remove();
    if(modo === 'quadras') layerGroupQuadras.addTo(mapPoligonos);
    else if(modo === 'territorios') layerGroupTerritorios.addTo(mapPoligonos);
    else { layerGroupQuadras.addTo(mapPoligonos); layerGroupTerritorios.addTo(mapPoligonos); }
  }
  function atualizarVisibilidadeLabels() {
    layerGroupTerritoryLabels.eachLayer(l => {
      const visivel = showTerritoryNumbers && (l.metaData.labelType === 'visible' || (l.metaData.labelType === 'optional' && showOptionalLabels));
      if(visivel) { if(!mapPoligonos.hasLayer(l)) l.addTo(mapPoligonos); } else { l.remove(); }
    });
  }
  function toggleNumerosTerritorios(v) { showTerritoryNumbers = v; atualizarVisibilidadeLabels(); }
  function toggleOptionalLabels(v) { showOptionalLabels = v; atualizarVisibilidadeLabels(); }
  function toggleSelecaoQuadra(layer) {
    const id = layer.metaData.id;
    const idx = window.selectedQuadras.findIndex(q => q.id === id);
    if (idx === -1) { window.selectedQuadras.push({ id: id, layer: layer }); layer.setStyle({ color: 'red', weight: 4, dashArray: '10,5' }); }
    else { window.selectedQuadras.splice(idx, 1); layer.setStyle({ color: '#666', weight: 1, dashArray: null }); }
    atualizarBotoesSelecao();
  }
  function limparSelecao() { window.selectedQuadras.forEach(i => i.layer.setStyle({ color: '#666', weight: 1, dashArray: null })); window.selectedQuadras = []; atualizarBotoesSelecao(); }
  function calcularUniao() {
    if(window.selectedQuadras.length === 0) return "";
    const feats = window.selectedQuadras.map(i => i.layer.toGeoJSON());
    let u = feats[0];
    for(let i=1; i<feats.length; i++) try { u = turf.union(u, feats[i]); } catch(e){}
    const c = u.geometry.type === "Polygon" ? u.geometry.coordinates[0] : u.geometry.coordinates[0][0];
    return c.map(p => p[1] + "," + p[0]).join(" | ");
  }
  function calcularUniaoIds(ids) {
    const feats = [];
    layerGroupQuadras.eachLayer(l => { if(ids.includes(l.metaData.id)) feats.push(l.toGeoJSON()); });
    if(feats.length===0) return "";
    let u = feats[0]; for(let i=1; i<feats.length; i++) try { u = turf.union(u, feats[i]); } catch(e){}
    const c = u.geometry.type === "Polygon" ? u.geometry.coordinates[0] : u.geometry.coordinates[0][0];
    return c.map(p => p[1] + "," + p[0]).join(" | ");
  }
  function formatarTextoBadge(t) { return t.toString().replace(" ", "<br>"); }
  function setLabelDraggable(name, enable) {
    layerGroupTerritoryLabels.eachLayer(l => { if(l.metaData.territoryName === name) {
      if(enable) { if(!mapPoligonos.hasLayer(l)) l.addTo(mapPoligonos); l.dragging.enable(); if(l._icon) l._icon.style.cursor="move"; }
      else { l.dragging.disable(); if(l._icon) l._icon.style.cursor="default"; }
    }});
  }
  function getLabelPosition(name) { let pos=null; layerGroupTerritoryLabels.eachLayer(l => { if(l.metaData.territoryName === name) { const p=l.getLatLng(); pos=p.lat + "," + p.lng; }}); return pos; }
  function getTerritorioPorNome(name) { let d=null; layerGroupTerritorios.eachLayer(l=>{ if(l.metaData.name===name) d=l.metaData; }); return d; }
  function ativarSelecaoVerticesDivisao(layer) {
    layerGroupVerticesTemp.clearLayers(); verticesSelecionados = [];
    layer.getLatLngs()[0].forEach(p => {
       const m = L.circleMarker(p, { radius: 5, color: 'blue', fillColor: 'white', fillOpacity: 1 });
       m.on('click', e => { L.DomEvent.stopPropagation(e); verticesSelecionados.push(p); m.setStyle({color:'red', fillColor:'red'}); if(verticesSelecionados.length===2) executarCorte(layer, verticesSelecionados); });
       layerGroupVerticesTemp.addLayer(m);
    });
  }
  function executarCorte(layer, pontos) {
    const gj = layer.toGeoJSON();
    const line = turf.lineString([[pontos[0].lng, pontos[0].lat], [pontos[1].lng, pontos[1].lat]]);
    const cut = turf.buffer(line, 0.0001, {units:'kilometers'});
    const diff = turf.difference(gj, cut);
    if(!diff) return alert("Erro no corte.");
    const partes = diff.geometry.type==='MultiPolygon' ? diff.geometry.coordinates.map(c=>turf.polygon(c)) : [diff];
    receberCorte(partes);
  }
  function atualizarMapaDetalhes(grupos) {
     if(!mapDetalhe) { mapDetalhe=L.map('mapDetalhe'); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mapDetalhe); }
     mapDetalhe.eachLayer(l => mapDetalhe.removeLayer(l));
     const bounds = [];
     Object.values(grupos).forEach(g => { if(g.lat && g.lng) { L.marker([g.lat, g.lng]).addTo(mapDetalhe); bounds.push([g.lat, g.lng]); }});
     if(bounds.length>0) { mapDetalhe.fitBounds(bounds, {padding:[20,20]}); setTimeout(()=>mapDetalhe.invalidateSize(), 300); }
  }
</script>