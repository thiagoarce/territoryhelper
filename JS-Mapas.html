<script>
  // Variável para guardar o modo de visualização atual (padrão: mostrar ID)
  let modoRotuloAtual = 'id';

  // --- MAPA GERAL (Visão Visitantes) ---
  function carregarMapaGeral() {
    google.script.run.withSuccessHandler(dados => {
      document.getElementById('totalQuadrasGeral').innerText = dados.length;
      document.getElementById('totalDomiciliosGeral').innerText = dados.reduce((acc, c) => acc + c.total, 0);

      if(!mapGeral) {
        mapGeral = L.map('mapGeral').setView([-7.115, -34.863], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mapGeral);
      }

      dados.forEach(q => {
        if(q.lat && q.lng) {
          L.marker([q.lat, q.lng]).addTo(mapGeral)
           .bindPopup(`<div class="popup-quadra"><h6>${q.id}</h6><p>${q.total} Domicílios</p><button class="btn btn-sm btn-primary btn-ver-quadra" onclick="irParaDetalhes('${q.id}')">Ver</button></div>`);
        }
      });
      showLoading(false);
    }).getVisaoGeral();
  }

  // --- MAPA EDITOR (POLÍGONOS) ---
  function iniciarMapaPoligonos() {
    // Se o mapa ainda não existe, cria.
    if (!mapPoligonos) {
      mapPoligonos = L.map('mapPoligonos').setView([-7.115, -34.863], 14);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mapPoligonos);
      mapPoligonos.pm.setGlobalOptions({ allowSelfIntersection: false });
    }

    showLoading(true, "Carregando Malha...");
    
    // Limpa camadas antigas para recarregar
    mapPoligonos.eachLayer((layer) => { 
      if(layer instanceof L.Polygon) mapPoligonos.removeLayer(layer); 
    });

    google.script.run.withSuccessHandler(dados => {
      if(!dados || dados.length === 0) { showLoading(false); return; }
      
      const grupo = L.featureGroup();
      dados.forEach(d => {
        if (d.polyString && d.polyString.length > 5) {
          const latlngs = d.polyString.split(" | ").map(par => {
            const c = par.split(","); return [parseFloat(c[0]), parseFloat(c[1])];
          });

          const poly = L.polygon(latlngs, {
            color: d.color, fillColor: d.color, fillOpacity: 0.3, weight: 2
          });
          
          poly.metaData = { ...d }; // Guarda dados no objeto
          poly.on('click', function() { abrirModalEdicao(this); });
          
          // --- AQUI ADICIONAMOS O RÓTULO (TOOLTIP) ---
          atualizarTextoTooltip(poly, modoRotuloAtual);
          
          grupo.addLayer(poly);
        }
      });
      grupo.addTo(mapPoligonos);
      try { mapPoligonos.fitBounds(grupo.getBounds()); } catch(e){}
      showLoading(false);
    }).getPoligonosQuadras();
  }

  // --- FUNÇÃO NOVA: GERENCIA A TROCA DE RÓTULOS ---
  function mudarRotulos(modo) {
    modoRotuloAtual = modo;
    
    // Varre todas as camadas do mapa e atualiza
    if(mapPoligonos) {
      mapPoligonos.eachLayer(layer => {
        if (layer instanceof L.Polygon && layer.metaData) {
          atualizarTextoTooltip(layer, modo);
        }
      });
    }
  }

  // Helper para definir o texto do tooltip
  function atualizarTextoTooltip(poly, modo) {
    let texto = "";
    const dados = poly.metaData;

    if (modo === 'id') {
      texto = dados.id;
    } else if (modo === 'territory') {
      texto = dados.territory;
    } else if (modo === 'both') {
      texto = `${dados.id}<br><span style="font-weight:normal; font-size:0.9em">${dados.territory}</span>`;
    }

    // Se tiver texto e não for 'none', mostra. Caso contrário, remove.
    if (modo !== 'none' && texto) {
      poly.bindTooltip(texto, {
        permanent: true,     // Sempre visível
        direction: "center", // No centro do polígono
        className: "label-quadra" // Nossa classe CSS
      }).openTooltip();
    } else {
      poly.unbindTooltip();
    }
  }

  // --- MAPA DETALHES ---
  function atualizarMapaDetalhes(grupos) {
    if(!mapDetalhe) {
      mapDetalhe = L.map('mapDetalhe');
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mapDetalhe);
    }
    // Limpa marcadores antigos
    mapDetalhe.eachLayer((layer) => { if(layer instanceof L.Marker) mapDetalhe.removeLayer(layer); });

    const bounds = [];
    Object.values(grupos).forEach(g => {
      if(g.lat && g.lng) {
        L.marker([g.lat, g.lng]).addTo(mapDetalhe).bindPopup(`<b>${g.numero}</b> ${g.logradouro}`);
        bounds.push([g.lat, g.lng]);
      }
    });

    if(bounds.length > 0) mapDetalhe.fitBounds(bounds, {padding:[30,30]});
    else mapDetalhe.setView([-7.115, -34.863], 14);
    
    setTimeout(() => mapDetalhe.invalidateSize(), 300);
  }
</script>