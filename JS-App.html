<script>
  let mapGeral, mapDetalhe, mapPoligonos;
  let currentEditLayer = null;
  let modalEdicao, modalNovoTerritorio, modalNomear;
  
  let tempOperacao = null; 
  let tempPoligonosGerados = []; 
  let tempIdsOriginais = [];

  window.onload = function() {
    modalEdicao = new bootstrap.Modal(document.getElementById('modalEdicao'));
    modalNovoTerritorio = new bootstrap.Modal(document.getElementById('modalNovoTerritorio'));
    modalNomear = new bootstrap.Modal(document.getElementById('modalNomear'));
    iniciarApp();
  };

  function iniciarApp() {
    showLoading(true, "Iniciando...");
    google.script.run.withSuccessHandler(lista => {
      const sel = document.getElementById('selectQuadra');
      lista.forEach(q => { let opt = document.createElement('option'); opt.value = q; opt.text = q; sel.appendChild(opt); });
    }).getListaQuadras();
    carregarMapaGeral();
  }

  function showLoading(show, text="Carregando...") {
    document.getElementById('loadingText').innerText = text;
    document.getElementById('loading').style.display = show ? 'flex' : 'none';
  }

  function mudarAba(aba) {
    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
    if(aba === 'geral') { document.getElementById('btnAbaGeral').classList.add('active'); document.getElementById('telaGeral').classList.add('active'); setTimeout(() => mapGeral && mapGeral.invalidateSize(), 200); }
    else if(aba === 'poligonos') { document.getElementById('btnAbaPoligonos').classList.add('active'); document.getElementById('telaPoligonos').classList.add('active'); if (!mapPoligonos) iniciarMapaPoligonos(); else setTimeout(() => mapPoligonos.invalidateSize(), 200); }
    else { document.getElementById('btnAbaDetalhe').classList.add('active'); document.getElementById('telaDetalhe').classList.add('active'); setTimeout(() => mapDetalhe && mapDetalhe.invalidateSize(), 200); }
  }

  function irParaDetalhes(id) {
    document.getElementById('selectQuadra').value = id;
    mudarAba('detalhe');
    carregarQuadra(id);
  }

  // --- DETALHES ---
  function carregarQuadra(id) {
    showLoading(true); document.getElementById('infoArea').style.display='none';
    google.script.run.withSuccessHandler(renderizarDetalhes).getDadosDaQuadra(id);
  }
  function renderizarDetalhes(dados) {
    const titulo = document.getElementById('selectQuadra').value;
    document.getElementById('tituloQuadra').innerText = titulo;
    const grupos = {};
    dados.forEach(d => { const k = d.logradouro + '_' + d.numero; if(!grupos[k]) grupos[k] = { ...d, unidades: [] }; grupos[k].unidades.push(d); });
    document.getElementById('totalEnderecos').innerText = Object.keys(grupos).length;
    document.getElementById('totalUnidades').innerText = dados.length;
    atualizarMapaDetalhes(grupos);
    let html = '';
    Object.values(grupos).forEach((g, i) => {
       const qtd = g.unidades.length; const isPredio = qtd > 1; const idCol = `c${i}`; const icon = isPredio ? '<i class="fa-solid fa-building"></i>' : '<i class="fa-solid fa-house"></i>';
       const nome = g.nomeEdificio ? `<span class="nome-predio">${g.nomeEdificio}</span>` : '';
       if(isPredio) { html += `<div class="accordion-item"><h2 class="accordion-header"><button class="accordion-button collapsed" data-bs-toggle="collapse" data-bs-target="#${idCol}"><div class="w-100">${nome}<span>${icon} <span class="numero-destaque">${g.numero}</span> ${g.logradouro} <span class="badge bg-secondary ms-2">${qtd}</span></span></div></button></h2><div id="${idCol}" class="accordion-collapse collapse"><div class="accordion-body p-0"><ul class="list-group list-group-flush">${g.unidades.map(u=>`<li class="list-group-item d-flex justify-content-between"><span>${u.complemento||'Apt'}</span><div class="check-visit" onclick="this.classList.toggle('checked')"></div></li>`).join('')}</ul></div></div></div>`; }
       else { html += `<div class="list-group-item d-flex justify-content-between align-items-center p-3 bg-white border mb-1 rounded"><div>${nome}<span>${icon} <span class="numero-destaque">${g.numero}</span> ${g.logradouro}</span></div><div class="check-visit" onclick="this.classList.toggle('checked')"></div></div>`; }
    });
    document.getElementById('listaEnderecos').innerHTML = html;
    document.getElementById('infoArea').style.display = 'block';
    showLoading(false);
  }

  // --- SELEÇÃO EM MASSA (JUNTAR/TERRITÓRIO) ---
  function alternarModoSelecao(ativo) {
    window.isSelectionMode = ativo;
    const msg = document.getElementById('msgHelp');
    const btns = [document.getElementById('btnSalvarTerritorio'), document.getElementById('btnJuntarQuadras')];
    if (ativo) { msg.innerText = "Selecione quadras para Juntar ou criar Território."; msg.classList.add("text-primary", "fw-bold"); }
    else { msg.innerText = "Clique em uma quadra para editar."; msg.classList.remove("text-primary", "fw-bold"); limparSelecao(); btns.forEach(b => b.classList.add("disabled")); }
  }

  function atualizarBotoesSelecao() {
    const qtd = window.selectedQuadras.length;
    document.getElementById('countSelectedBadge').innerText = qtd + " selecionados";
    
    // Regras de Habilitação
    const btnTerritorio = document.getElementById('btnSalvarTerritorio');
    if(qtd > 0) btnTerritorio.classList.remove('disabled'); else btnTerritorio.classList.add('disabled');

    const btnJuntar = document.getElementById('btnJuntarQuadras');
    if(qtd >= 2) btnJuntar.classList.remove('disabled'); else btnJuntar.classList.add('disabled');
  }

  // --- TERRITÓRIOS ---
  function abrirModalSalvarTerritorio() {
    if (window.selectedQuadras.length === 0) return;
    document.getElementById('lblCountTerritorio').innerText = window.selectedQuadras.length;
    modalNovoTerritorio.show();
  }
  function confirmarSalvarTerritorio() {
    const nome = document.getElementById('newTerritoryName').value;
    const cor = document.getElementById('newTerritoryColor').value;
    if(!nome) { alert("Digite um nome."); return; }
    showLoading(true, "Unindo..."); modalNovoTerritorio.hide();
    const uniao = calcularUniaoQuadras(); // JS-Mapas
    const payload = { name: nome, color: cor, idsQuadras: window.selectedQuadras.map(q => q.id), polyString: uniao };
    google.script.run.withSuccessHandler(resp => {
      if(resp.erro) alert(resp.erro); else { alert("Criado!"); alternarModoSelecao(false); iniciarMapaPoligonos(); }
      showLoading(false);
    }).salvarCriacaoTerritorio(payload);
  }

  // --- FUSÃO (MERGE) ---
  function iniciarFusaoQuadras() {
    if (window.selectedQuadras.length < 2) return;
    
    tempOperacao = 'merge';
    tempIdsOriginais = window.selectedQuadras.map(q => q.id);
    
    const geojsonUniao = calcularUniaoQuadrasGeoJSON(); // JS-Mapas
    if (!geojsonUniao) { alert("Erro ao unir."); return; }
    
    tempPoligonosGerados = [geojsonUniao];
    
    document.getElementById('lblTituloNomear').innerText = "Juntar Quadras";
    document.getElementById('msgNomear').innerText = `As quadras serão unidas em uma só.`;
    document.getElementById('containerInputsNomes').innerHTML = `<div class="mb-2"><label>ID da Nova Quadra Unificada</label><input type="text" class="form-control" id="inputNomePart0" value="${tempIdsOriginais[0]}_unida"></div>`;
    modalNomear.show();
  }

  // --- DIVISÃO POR VÉRTICES (NOVO) ---
  function iniciarDivisaoPorVertices() {
    if (!currentEditLayer) return;

    // Fecha o modal de edição
    modalEdicao.hide();
    
    tempOperacao = 'split';
    tempIdsOriginais = [currentEditLayer.metaData.id];

    alert("MODO DIVISÃO:\n\n1. Aparecerão pontos brancos nos vértices da quadra.\n2. Clique no PRIMEIRO vértice.\n3. Clique no SEGUNDO vértice para traçar a linha de corte.");
    
    // Chama função no JS-Mapas para mostrar os vértices clicáveis
    ativarSelecaoVerticesDivisao(currentEditLayer);
  }

  // Callback chamado pelo JS-Mapas quando o usuário escolheu os 2 pontos
  function receberCorteRealizado(novasPartes) {
    if (!novasPartes || novasPartes.length < 2) {
      alert("O corte falhou. Tente escolher vértices opostos.");
      iniciarMapaPoligonos();
      return;
    }
    
    tempPoligonosGerados = novasPartes;
    
    document.getElementById('lblTituloNomear').innerText = "Dividir Quadra";
    document.getElementById('msgNomear').innerText = `Quadra dividida em ${novasPartes.length} partes. Nomeie-as:`;
    
    const container = document.getElementById('containerInputsNomes');
    container.innerHTML = "";
    tempPoligonosGerados.forEach((p, i) => {
      container.innerHTML += `<div class="mb-2"><label>Nome da Parte ${i+1}</label><input type="text" class="form-control" id="inputNomePart${i}" value="${tempIdsOriginais[0]}_${i+1}"></div>`;
    });
    
    modalNomear.show();
  }

  // --- CONFIRMAÇÃO FINAL (SALVAR) ---
  function confirmarOperacaoGeometrica() {
    const novosItems = [];
    for (let i = 0; i < tempPoligonosGerados.length; i++) {
      const nome = document.getElementById(`inputNomePart${i}`).value;
      if (!nome) { alert("Preencha todos os nomes."); return; }
      
      const coords = tempPoligonosGerados[i].geometry.coordinates[0]; 
      const polyString = coords.map(c => `${c[1]},${c[0]}`).join(" | ");
      const centro = turf.center(tempPoligonosGerados[i]).geometry.coordinates;

      novosItems.push({
        id: nome,
        polyString: polyString,
        centro: [centro[1], centro[0]], // lat, lon
        area: 0, 
        color: '#3388ff', 
        territory: ''
      });
    }

    const payload = { toRemove: tempIdsOriginais, toAdd: novosItems };
    showLoading(true, "Salvando...");
    modalNomear.hide();
    
    google.script.run.withSuccessHandler(resp => {
      if(resp.erro) alert(resp.erro);
      else {
        alert("Sucesso!");
        alternarModoSelecao(false);
        iniciarMapaPoligonos(); 
      }
      showLoading(false);
    }).processarGeometriaEmLote(payload);
  }

  function cancelarOperacaoGeometrica() {
    iniciarMapaPoligonos();
  }

  // --- EDIÇÃO INDIVIDUAL ---
  function abrirModalEdicao(layer) {
    if(window.isSelectionMode) return;
    currentEditLayer = layer;
    const dados = layer.metaData;
    document.getElementById('editOriginalId').value = dados.id;
    document.getElementById('editId').value = dados.id;
    document.getElementById('editTerritory').value = dados.territory;
    document.getElementById('editColor').value = dados.color;
    document.getElementById('btnToggleVertex').classList.remove('active');
    
    if(layer.pm.enabled()) layer.pm.disable();
    modalEdicao.show();
  }

  function ativarEdicaoVertices() { if(!currentEditLayer)return; modalEdicao.hide(); currentEditLayer.pm.enable({ allowSelfIntersection:false, draggable:false }); alert("Arraste os pontos. Clique na quadra para SALVAR."); }

  function salvarQuadraAtual() {
    if(!currentEditLayer) return; showLoading(true,"Salvando...");
    const pl = { idOriginal:document.getElementById('editOriginalId').value, idNovo:document.getElementById('editId').value, color:document.getElementById('editColor').value, territory:document.getElementById('editTerritory').value, polyString:currentEditLayer.getLatLngs()[0].map(p=>`${p.lat},${p.lng}`).join(" | "), centro:[currentEditLayer.getCenter().lat, currentEditLayer.getCenter().lng], area:0 };
    google.script.run.withSuccessHandler(r=>{ if(r.erro)alert(r.erro); else { currentEditLayer.setStyle({color:pl.color, fillColor:pl.color}); currentEditLayer.metaData={id:pl.idNovo, color:pl.color, territory:pl.territory}; if(currentEditLayer.pm.enabled())currentEditLayer.pm.disable(); modalEdicao.hide(); } showLoading(false); }).salvarEdicaoQuadra(pl);
  }

  function deletarQuadraAtual() { if(!confirm("Excluir?"))return; showLoading(true); google.script.run.withSuccessHandler(r=>{ if(r.erro)alert(r.erro); else{mapPoligonos.removeLayer(currentEditLayer);modalEdicao.hide();} showLoading(false); }).excluirQuadra(document.getElementById('editOriginalId').value); }
</script>