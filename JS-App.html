<script>
  // Variáveis Globais (Compartilhadas com o mapa)
  let mapGeral, mapDetalhe, mapPoligonos;
  let currentEditLayer = null;
  let modalEdicao;

  window.onload = function() {
    modalEdicao = new bootstrap.Modal(document.getElementById('modalEdicao'));
    iniciarApp();
  };

  function iniciarApp() {
    showLoading(true, "Iniciando...");
    google.script.run.withSuccessHandler(lista => {
      const sel = document.getElementById('selectQuadra');
      lista.forEach(q => { let opt = document.createElement('option'); opt.value = q; opt.text = q; sel.appendChild(opt); });
    }).getListaQuadras();
    
    // Inicia o Mapa Geral (Função está no arquivo JS-Mapas)
    carregarMapaGeral();
  }

  function showLoading(show, text="Carregando...") {
    document.getElementById('loadingText').innerText = text;
    document.getElementById('loading').style.display = show ? 'flex' : 'none';
  }

  // --- NAVEGAÇÃO ---
  function mudarAba(aba) {
    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));

    if(aba === 'geral') {
      document.getElementById('btnAbaGeral').classList.add('active');
      document.getElementById('telaGeral').classList.add('active');
      setTimeout(() => mapGeral && mapGeral.invalidateSize(), 200);
    } else if(aba === 'poligonos') {
      document.getElementById('btnAbaPoligonos').classList.add('active');
      document.getElementById('telaPoligonos').classList.add('active');
      if (!mapPoligonos) iniciarMapaPoligonos(); // Está no JS-Mapas
      else setTimeout(() => mapPoligonos.invalidateSize(), 200);
    } else {
      document.getElementById('btnAbaDetalhe').classList.add('active');
      document.getElementById('telaDetalhe').classList.add('active');
      setTimeout(() => mapDetalhe && mapDetalhe.invalidateSize(), 200);
    }
  }

  // --- CONTROLE DE DETALHES ---
  function irParaDetalhes(id) {
    document.getElementById('selectQuadra').value = id;
    mudarAba('detalhe');
    carregarQuadra(id);
  }

  function carregarQuadra(id) {
    showLoading(true); 
    document.getElementById('infoArea').style.display='none';
    google.script.run.withSuccessHandler(renderizarDetalhes).getDadosDaQuadra(id);
  }

  function renderizarDetalhes(dados) {
    const titulo = document.getElementById('selectQuadra').value;
    document.getElementById('tituloQuadra').innerText = titulo;
    
    // Agrupa dados
    const grupos = {};
    dados.forEach(d => {
      const k = d.logradouro + '_' + d.numero;
      if(!grupos[k]) grupos[k] = { ...d, unidades: [] };
      grupos[k].unidades.push(d);
    });

    document.getElementById('totalEnderecos').innerText = Object.keys(grupos).length;
    document.getElementById('totalUnidades').innerText = dados.length;

    // Desenha pins no mapinha de detalhes
    atualizarMapaDetalhes(grupos); // Função no JS-Mapas

    // Gera HTML da lista
    let html = '';
    Object.values(grupos).forEach((g, i) => {
       const qtd = g.unidades.length;
       const isPredio = qtd > 1 || (g.nomeEdificio && g.nomeEdificio.length > 2);
       const idCol = `c${i}`;
       const icon = isPredio ? '<i class="fa-solid fa-building"></i>' : '<i class="fa-solid fa-house"></i>';
       const nomeShow = g.nomeEdificio ? `<span class="nome-predio">${g.nomeEdificio}</span>` : '';
       
       if(isPredio) {
         html += `<div class="accordion-item"><h2 class="accordion-header"><button class="accordion-button collapsed" data-bs-toggle="collapse" data-bs-target="#${idCol}"><div class="w-100">${nomeShow}<span>${icon} <span class="numero-destaque">${g.numero}</span> ${g.logradouro} <span class="badge bg-secondary ms-2">${qtd}</span></span></div></button></h2><div id="${idCol}" class="accordion-collapse collapse"><div class="accordion-body p-0"><ul class="list-group list-group-flush">${g.unidades.map(u=>`<li class="list-group-item d-flex justify-content-between"><span>${u.complemento||'Apt'}</span> <div class="check-visit" onclick="this.classList.toggle('checked')"></div></li>`).join('')}</ul></div></div></div>`;
       } else {
         html += `<div class="list-group-item d-flex justify-content-between align-items-center p-3 bg-white border mb-1 rounded"><div>${nomeShow}<span>${icon} <span class="numero-destaque">${g.numero}</span> ${g.logradouro}</span></div> <div class="check-visit" onclick="this.classList.toggle('checked')"></div></div>`;
       }
    });
    document.getElementById('listaEnderecos').innerHTML = html;
    document.getElementById('infoArea').style.display = 'block';
    showLoading(false);
  }

  // --- CONTROLE DE EDIÇÃO (Salvar/Excluir) ---
  function abrirModalEdicao(layer) {
    currentEditLayer = layer;
    const dados = layer.metaData;
    document.getElementById('editOriginalId').value = dados.id;
    document.getElementById('editId').value = dados.id;
    document.getElementById('editTerritory').value = dados.territory;
    document.getElementById('editColor').value = dados.color;
    
    // Reseta UI do modal
    document.getElementById('btnToggleVertex').classList.remove('active');
    document.getElementById('msgVertex').style.display = 'none';
    if(layer.pm.enabled()) layer.pm.disable();

    modalEdicao.show();
  }

  function ativarEdicaoVertices() {
    if(!currentEditLayer) return;
    modalEdicao.hide();
    currentEditLayer.pm.enable({ allowSelfIntersection: false, draggable: false });
    alert("MODO EDIÇÃO:\nArraste os pontos brancos.\nClique na quadra novamente para SALVAR.");
  }

  function salvarQuadraAtual() {
    if(!currentEditLayer) return;
    showLoading(true, "Salvando...");

    const payload = {
      idOriginal: document.getElementById('editOriginalId').value,
      idNovo: document.getElementById('editId').value,
      color: document.getElementById('editColor').value,
      territory: document.getElementById('editTerritory').value,
      polyString: currentEditLayer.getLatLngs()[0].map(p => `${p.lat},${p.lng}`).join(" | "),
      centro: [currentEditLayer.getCenter().lat, currentEditLayer.getCenter().lng],
      area: 0 // Simplificado
    };

    google.script.run.withSuccessHandler(resp => {
      if(resp.erro) alert("Erro: " + resp.erro);
      else {
        currentEditLayer.setStyle({ color: payload.color, fillColor: payload.color });
        currentEditLayer.metaData = { id: payload.idNovo, color: payload.color, territory: payload.territory };
        if(currentEditLayer.pm.enabled()) currentEditLayer.pm.disable();
        modalEdicao.hide();
        alert("Salvo!");
      }
      showLoading(false);
    }).salvarEdicaoQuadra(payload);
  }

  function deletarQuadraAtual() {
    if(!confirm("Excluir permanentemente?")) return;
    showLoading(true, "Excluindo...");
    google.script.run.withSuccessHandler(resp => {
      if(resp.erro) alert(resp.erro);
      else {
        mapPoligonos.removeLayer(currentEditLayer);
        modalEdicao.hide();
      }
      showLoading(false);
    }).excluirQuadra(document.getElementById('editOriginalId').value);
  }
</script>