<script>
  let modalEdicao, modalNovoTerritorio, modalNomear, modalEditarTerritorio;
  let isEditingTerritory = false; let editingTerritoryData = null;
  let tempPartes = []; let tempIdOriginal = "";
  let registroSelecionados = new Set();
  
  window.onload = function() {
    modalEdicao = new bootstrap.Modal(document.getElementById('modalEdicao'));
    modalNovoTerritorio = new bootstrap.Modal(document.getElementById('modalNovoTerritorio'));
    modalNomear = new bootstrap.Modal(document.getElementById('modalNomear'));
    modalEditarTerritorio = new bootstrap.Modal(document.getElementById('modalEditarTerritorio'));
    document.getElementById('dataRegistro').valueAsDate = new Date();
    iniciarApp();
  };
  
  function iniciarApp() {
    showLoading(true, "Iniciando...");
    google.script.run.withSuccessHandler(lista => {
      const sel = document.getElementById('selectQuadra');
      lista.forEach(q => { let opt = document.createElement('option'); opt.value = q; opt.text = q; sel.appendChild(opt); });
    }).getListaQuadras();
    carregarMapaGeral();
  }
  
  function mudarAba(aba) {
    document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
    document.querySelectorAll('.screen').forEach(e => e.classList.remove('active'));
    document.getElementById('btnAba'+(aba.charAt(0).toUpperCase()+aba.slice(1))).classList.add('active');
    
    if(aba === 'geral') { document.getElementById('telaGeral').classList.add('active'); if(mapGeral) setTimeout(()=>mapGeral.invalidateSize(), 200); }
    else if(aba === 'poligonos') { document.getElementById('telaPoligonos').classList.add('active'); if(!mapPoligonos) iniciarMapaPoligonos(); else setTimeout(()=>mapPoligonos.invalidateSize(), 200); }
    else if(aba === 'registro') { 
        document.getElementById('telaRegistro').classList.add('active'); 
        carregarDadosRegistro(); // Chama carregamento do mapa registro
        if(mapRegistro) setTimeout(()=>mapRegistro.invalidateSize(), 200); 
    }
    else { document.getElementById('telaDetalhe').classList.add('active'); if(mapDetalhe) setTimeout(()=>mapDetalhe.invalidateSize(), 200); }
  }
  
  function showLoading(show, txt="Carregando...") { document.getElementById('loadingText').innerText = txt; document.getElementById('loading').style.display = show ? 'flex' : 'none'; }
  function irParaDetalhes(id) { document.getElementById('selectQuadra').value = id; mudarAba('detalhe'); carregarQuadra(id); }
  function carregarQuadra(id) { showLoading(true); google.script.run.withSuccessHandler(renderDetalhes).getDadosDaQuadra(id); }
  function renderDetalhes(dados) {
    document.getElementById('tituloQuadra').innerText = document.getElementById('selectQuadra').value;
    const grupos = {}; let lat=0, lng=0, c=0;
    dados.forEach(d => {
       const k = d.logradouro + '_' + d.numero;
       if(!grupos[k]) grupos[k] = { ...d, unidades: [] }; grupos[k].unidades.push(d);
       if(d.lat && d.lng) { lat+=d.lat; lng+=d.lng; c++; }
    });
    const btn = document.getElementById('btnRotaDetalhe');
    if(c>0) { btn.style.display='block'; btn.onclick=()=>{ abrirRota(lat/c, lng/c); }; } else { btn.style.display='none'; }
    let html = '';
    Object.values(grupos).forEach((g,i) => {
       const isPredio = g.unidades.length > 1;
       if(isPredio) {
         html += '<div class="accordion-item"><h2 class="accordion-header"><button class="accordion-button collapsed" data-bs-toggle="collapse" data-bs-target="#c'+i+'"><div>' + (g.nomeEdificio||'') + ' <b>' + g.numero + '</b> ' + g.logradouro + ' <span class="badge bg-secondary">' + g.unidades.length + '</span></div></button></h2><div id="c'+i+'" class="accordion-collapse collapse"><div class="accordion-body p-0"><ul class="list-group list-group-flush">' + g.unidades.map(u=>'<li class="list-group-item d-flex justify-content-between"><span>' + (u.complemento||'Apt') + '</span><div class="check-visit" onclick="this.classList.toggle(\'checked\')"></div></li>').join('') + '</ul></div></div></div>';
       } else {
         html += '<div class="list-group-item d-flex justify-content-between p-3 bg-white border mb-1"><div><b>' + g.numero + '</b> ' + g.logradouro + '</div><div class="check-visit" onclick="this.classList.toggle(\'checked\')"></div></div>';
       }
    });
    document.getElementById('listaEnderecos').innerHTML = html;
    document.getElementById('totalEnderecos').innerText = Object.keys(grupos).length;
    document.getElementById('infoArea').style.display = 'block';
    atualizarMapaDetalhes(grupos);
    showLoading(false);
  }

  // --- EDITOR ---
  function alternarModoSelecao(ativo) { window.isSelectionMode = ativo; const msg = document.getElementById('msgHelp'); if(ativo) { msg.innerText = "Selecione múltiplas quadras."; msg.classList.add("text-primary","fw-bold"); } else { msg.innerText = "Clique para editar."; msg.classList.remove("text-primary","fw-bold"); limparSelecao(); } }
  function atualizarBotoesSelecao() {
    const n = window.selectedQuadras.length;
    document.getElementById('countSelectedBadge').innerText = n;
    if(!isEditingTerritory) {
       document.getElementById('btnSalvarTerritorio').className = n>0 ? "btn btn-sm btn-success flex-fill" : "btn btn-sm btn-success flex-fill disabled";
       document.getElementById('btnJuntarQuadras').className = n>1 ? "btn btn-sm btn-primary flex-fill" : "btn btn-sm btn-primary flex-fill disabled";
    }
  }
  function abrirModalSalvarTerritorio() { document.getElementById('lblCountTerritorio').innerText = window.selectedQuadras.length; modalNovoTerritorio.show(); }
  function confirmarSalvarTerritorio() {
    const nome = document.getElementById('newTerritoryName').value;
    if(!nome) return alert("Digite o nome");
    showLoading(true, "Salvando..."); modalNovoTerritorio.hide();
    const polyString = calcularUniao();
    const ids = window.selectedQuadras.map(q => q.id);
    const updates = [{ name: nome, color: document.getElementById('newTerritoryColor').value, idsQuadras: ids, polyString: polyString, labelType: document.getElementById('newTerritoryLabelType').value }];
    const vitimas = new Set();
    window.selectedQuadras.forEach(q => { if(q.layer.metaData.territory) vitimas.add(q.layer.metaData.territory); });
    vitimas.forEach(vName => {
       const tData = getTerritorioPorNome(vName);
       if(tData) {
         const idsAntigos = tData.quadras.split(",");
         const sobraram = idsAntigos.filter(id => !ids.includes(id));
         const polyNovo = calcularUniaoIds(sobraram);
         updates.push({ name: vName, color: tData.color, idsQuadras: sobraram, polyString: polyNovo, originalName: vName, labelPos: tData.labelPos, labelType: tData.labelType });
       }
    });
    google.script.run.withSuccessHandler(r => { alert("Salvo!"); document.getElementById('toggleSelectionMode').checked=false; alternarModoSelecao(false); iniciarMapaPoligonos(); }).salvarLoteTerritorios(updates);
  }
  function abrirModalEditarTerritorio(dados) { editingTerritoryData = dados; document.getElementById('editTerrOriginalName').value = dados.name; document.getElementById('editTerrName').value = dados.name; document.getElementById('editTerrColor').value = dados.color; document.getElementById('editTerrLabelType').value = dados.labelType || "visible"; modalEditarTerritorio.show(); }
  function iniciarSelecaoTerritorioExistente() {
    modalEditarTerritorio.hide(); isEditingTerritory = true;
    document.getElementById('divEditandoTerritorio').classList.remove('d-none'); document.getElementById('barraBotoesPadrao').classList.add('d-none'); document.getElementById('lblEditandoNome').innerText = editingTerritoryData.name;
    document.getElementById('toggleSelectionMode').checked = true; window.isSelectionMode = true;
    const ids = editingTerritoryData.quadras.split(",");
    if(layerGroupQuadras) { layerGroupQuadras.eachLayer(l => { if(ids.includes(l.metaData.id)) { window.selectedQuadras.push({id: l.metaData.id, layer: l}); l.setStyle({ color: 'red', weight: 4, dashArray: '10,5' }); } }); }
    atualizarBotoesSelecao(); setLabelDraggable(editingTerritoryData.name, true); alert("Adicione/Remova quadras. Arraste o nome para mover.");
  }
  function salvarRevisaoTerritorio() {
    showLoading(true, "Atualizando...");
    const novoNome = editingTerritoryData.name; const ids = window.selectedQuadras.map(q => q.id); const poly = calcularUniao(); const pos = getLabelPosition(novoNome);
    const updates = [{ name: novoNome, originalName: editingTerritoryData.name, color: editingTerritoryData.color, idsQuadras: ids, polyString: poly, labelPos: pos, labelType: editingTerritoryData.labelType }];
    const vitimas = new Set();
    window.selectedQuadras.forEach(q => { if(q.layer.metaData.territory && q.layer.metaData.territory !== novoNome) vitimas.add(q.layer.metaData.territory); });
    vitimas.forEach(vName => { const tData = getTerritorioPorNome(vName); if(tData) { const idsAnt = tData.quadras.split(","); const sob = idsAnt.filter(id => !ids.includes(id)); const pNov = calcularUniaoIds(sob); updates.push({ name: vName, color: tData.color, idsQuadras: sob, polyString: pNov, originalName: vName, labelPos: tData.labelPos }); } });
    google.script.run.withSuccessHandler(r => { alert("Salvo!"); isEditingTerritory=false; document.getElementById('divEditandoTerritorio').classList.add('d-none'); document.getElementById('barraBotoesPadrao').classList.remove('d-none'); document.getElementById('toggleSelectionMode').checked=false; alternarModoSelecao(false); iniciarMapaPoligonos(); }).salvarLoteTerritorios(updates);
  }
  function salvarTerritorioExistente() { const nome = document.getElementById('editTerrName').value; const cor = document.getElementById('editTerrColor').value; const type = document.getElementById('editTerrLabelType').value; modalEditarTerritorio.hide(); showLoading(true); const updates = [{ name: nome, originalName: editingTerritoryData.name, color: cor, idsQuadras: editingTerritoryData.quadras.split(","), polyString: editingTerritoryData.polyString, labelPos: editingTerritoryData.labelPos, labelType: type }]; google.script.run.withSuccessHandler(r=>{ alert("Atualizado"); iniciarMapaPoligonos(); }).salvarLoteTerritorios(updates); }
  function deletarTerritorioAtual() { if(!confirm("Excluir?")) return; modalEditarTerritorio.hide(); showLoading(true); google.script.run.withSuccessHandler(r=>{ alert("Excluído"); iniciarMapaPoligonos(); }).excluirTerritorio(document.getElementById('editTerrOriginalName').value); }
  
  // --- REGISTRO (VISUAL) ---
  function carregarDadosRegistro() {
    showLoading(true); registroSelecionados.clear();
    document.getElementById('countRegistro').innerText = "0";
    
    google.script.run.withSuccessHandler(quadras => {
       iniciarMapaRegistro(quadras); // JS-Mapas
       showLoading(false);
    }).getPoligonosQuadras();
  }
  
  function toggleReg(id) {
    if(registroSelecionados.has(id)) registroSelecionados.delete(id);
    else registroSelecionados.add(id);
    document.getElementById('countRegistro').innerText = registroSelecionados.size;
  }
  
  function salvarConclusao() {
    if(registroSelecionados.size===0) return alert("Selecione quadras no mapa");
    const dt = document.getElementById('dataRegistro').value;
    if(!dt) return alert("Data obrigatória");
    showLoading(true);
    google.script.run.withSuccessHandler(r=>{ alert("Salvo!"); carregarDadosRegistro(); }).salvarConclusaoQuadras({ ids: Array.from(registroSelecionados), data: dt });
  }

  // --- GEOMETRIA ---
  function iniciarDivisaoPorVertices() { modalEdicao.hide(); alert("Clique em 2 pontos brancos"); ativarSelecaoVerticesDivisao(currentEditLayer); }
  function receberCorte(partes) { tempPartes = partes; tempIdOriginal = document.getElementById('editOriginalId').value; const div = document.getElementById('containerInputsNomes'); div.innerHTML=""; partes.forEach((p,i) => { div.innerHTML += '<div class="mb-2"><label>Nome Parte ' + (i+1) + '</label><input class="form-control" id="nomePart' + i + '" value="' + tempIdOriginal + '_' + (i+1) + '"></div>'; }); modalNomear.show(); }
  function confirmarOperacaoGeometrica() { const novos = []; for(let i=0; i<tempPartes.length; i++) { const nm = document.getElementById('nomePart'+i).value; const coords = tempPartes[i].geometry.coordinates[0]; const poly = coords.map(c => c[1] + "," + c[0]).join(" | "); const center = turf.center(tempPartes[i]).geometry.coordinates; novos.push({ id: nm, polyString: poly, centro: [center[1], center[0]] }); } modalNomear.hide(); showLoading(true); google.script.run.withSuccessHandler(r=>{ alert("Sucesso"); iniciarMapaPoligonos(); }).processarGeometriaEmLote({ toRemove: [tempIdOriginal], toAdd: novos }); }
  function cancelarOperacaoGeometrica() { modalNomear.hide(); iniciarMapaPoligonos(); }
  function abrirModalEdicao(layer) { if(window.isSelectionMode) return; currentEditLayer = layer; const d = layer.metaData; document.getElementById('editOriginalId').value = d.id; document.getElementById('editId').value = d.id; document.getElementById('editTerritory').value = d.territory; document.getElementById('editColor').value = d.color; document.getElementById('btnToggleVertex').classList.remove('active'); if(layer.pm.enabled()) layer.pm.disable(); modalEdicao.show(); }
  function ativarEdicaoVertices() { modalEdicao.hide(); currentEditLayer.pm.enable({allowSelfIntersection:false, draggable:false}); alert("Edite os pontos e clique no polígono para salvar."); }
  function salvarQuadraAtual() { const novoId = document.getElementById('editId').value; const novoTerr = document.getElementById('editTerritory').value; const novaCor = document.getElementById('editColor').value; const poly = currentEditLayer.getLatLngs()[0].map(p=>p.lat + "," + p.lng).join(" | "); const center = currentEditLayer.getCenter(); modalEdicao.hide(); showLoading(true); google.script.run.withSuccessHandler(r=>{ alert("Salvo"); currentEditLayer.setStyle({color:novaCor, fillColor:novaCor}); currentEditLayer.metaData.id=novoId; currentEditLayer.metaData.territory=novoTerr; currentEditLayer.metaData.color=novaCor; showLoading(false); }).salvarEdicaoQuadra({ idOriginal: document.getElementById('editOriginalId').value, idNovo: novoId, territory: novoTerr, color: novaCor, polyString: poly, area:0, centro:[center.lat, center.lng] }); }
  function deletarQuadraAtual() { if(!confirm("Excluir?")) return; modalEdicao.hide(); showLoading(true); google.script.run.withSuccessHandler(r=>{ mapPoligonos.removeLayer(currentEditLayer); showLoading(false); }).excluirQuadra(document.getElementById('editOriginalId').value); }
</script>