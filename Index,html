<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>

    <style>
      body { background-color: #f8f9fa; font-family: 'Segoe UI', sans-serif; padding-bottom: 70px; /* Espaço pro menu footer */ }
      
      /* MAPAS */
      .map-wrapper { height: calc(100vh - 140px); width: 100%; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border: 1px solid #ddd; }
      #mapGeral { height: 100%; width: 100%; }
      #mapDetalhe { height: 250px; width: 100%; border-radius: 8px; margin-bottom: 15px; }

      /* CARDS DE QUADRAS (NO POPUP) */
      .popup-quadra { text-align: center; }
      .popup-quadra h6 { font-weight: bold; margin-bottom: 5px; color: #0d6efd; }
      .btn-ver-quadra { width: 100%; margin-top: 5px; }

      /* ACCORDION (LISTA) */
      .accordion-button { padding: 10px 15px; background: #fff; }
      .accordion-button:not(.collapsed) { background-color: #e7f1ff; color: #0d6efd; }
      .nome-predio { font-size: 0.85em; color: #0d6efd; font-weight: bold; display: block; }
      .numero-destaque { font-weight: 800; color: #d63384; }
      .lista-unidades { list-style: none; padding: 0; margin: 0; }
      .unidade-item { padding: 8px 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; font-size: 0.9em; }
      .check-visit { width: 22px; height: 22px; border: 2px solid #ccc; border-radius: 4px; cursor: pointer; }
      .check-visit.checked { background-color: #198754; border-color: #198754; position: relative; }
      .check-visit.checked::after { content: '✓'; color: white; position: absolute; top: -3px; left: 4px; font-size: 14px; }

      /* MENU INFERIOR FIXO */
      .bottom-nav { position: fixed; bottom: 0; width: 100%; background: white; border-top: 1px solid #ddd; display: flex; justify-content: space-around; padding: 10px 0; z-index: 2000; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); }
      .nav-item { text-align: center; color: #6c757d; cursor: pointer; flex: 1; }
      .nav-item.active { color: #0d6efd; font-weight: bold; }
      .nav-item i { font-size: 1.2rem; display: block; margin-bottom: 2px; }
      .nav-item span { font-size: 0.75rem; }

      /* ESTADO DE TELA */
      .screen { display: none; }
      .screen.active { display: block; animation: fadeIn 0.3s; }
      @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

      /* LOADING */
      .loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 3000; flex-direction: column; justify-content: center; align-items: center; }

      @media print {
        .bottom-nav, .no-print { display: none !important; }
        .screen { display: block !important; }
        #telaGeral { display: none !important; } /* Só imprime detalhe */
        #telaDetalhe { display: block !important; }
        body { padding: 0; }
      }
    </style>
  </head>
  <body>

    <div id="loading" class="loading-overlay">
      <div class="spinner-border text-primary" role="status"></div>
      <p class="mt-2 fw-bold text-secondary" id="loadingText">Carregando...</p>
    </div>

    <div id="telaGeral" class="screen active container-fluid py-3">
      <h5 class="fw-bold mb-3"><i class="fa-solid fa-earth-americas text-primary me-2"></i>Visão Geral</h5>
      
      <div class="row g-2 mb-3">
        <div class="col-6">
          <div class="p-3 bg-white border rounded shadow-sm text-center">
            <h3 class="fw-bold text-primary m-0" id="totalQuadrasGeral">-</h3>
            <small class="text-muted">Quadras</small>
          </div>
        </div>
        <div class="col-6">
          <div class="p-3 bg-white border rounded shadow-sm text-center">
            <h3 class="fw-bold text-success m-0" id="totalDomiciliosGeral">-</h3>
            <small class="text-muted">Domicílios</small>
          </div>
        </div>
      </div>

      <div class="map-wrapper">
        <div id="mapGeral"></div>
      </div>
    </div>

    <div id="telaDetalhe" class="screen container-fluid py-3">
      
      <div class="d-flex gap-2 mb-3 no-print">
        <select id="selectQuadra" class="form-select shadow-sm" onchange="carregarQuadra(this.value)">
          <option value="" selected disabled>Selecione uma quadra...</option>
        </select>
        <button class="btn btn-outline-secondary" onclick="window.print()"><i class="fa-solid fa-print"></i></button>
      </div>

      <div id="infoArea" style="display:none;">
        <h4 id="tituloQuadra" class="fw-bold text-dark mb-1"></h4>
        <p class="text-muted small mb-3"><span id="totalEnderecos">0</span> Endereços • <span id="totalUnidades">0</span> Domicílios</p>

        <div id="mapDetalhe"></div>

        <div class="accordion pb-5" id="listaEnderecos"></div>
      </div>
    </div>

    <div class="bottom-nav">
      <div class="nav-item active" onclick="mudarAba('geral')" id="btnAbaGeral">
        <i class="fa-solid fa-map-location-dot"></i>
        <span>Mapa Geral</span>
      </div>
      <div class="nav-item" onclick="mudarAba('detalhe')" id="btnAbaDetalhe">
        <i class="fa-solid fa-list-check"></i>
        <span>Quadra Atual</span>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

    <script>
      let mapGeral = null;
      let mapDetalhe = null;
      let layerGeral = null;
      let layerDetalhe = null;

      // --- INICIALIZAÇÃO ---
      window.onload = function() {
        iniciarApp();
      };

      function iniciarApp() {
        showLoading(true, "Carregando Território...");
        
        // Carrega Lista de Quadras para o Select
        google.script.run.withSuccessHandler(lista => {
          const sel = document.getElementById('selectQuadra');
          lista.forEach(q => {
            let opt = document.createElement('option');
            opt.value = q; opt.text = q;
            sel.appendChild(opt);
          });
        }).getListaQuadras();

        // Carrega Dados do Mapa Geral
        google.script.run.withSuccessHandler(renderizarMapaGeral).getVisaoGeral();
      }

      function showLoading(show, text="Carregando...") {
        document.getElementById('loadingText').innerText = text;
        document.getElementById('loading').style.display = show ? 'flex' : 'none';
      }

      // --- NAVEGAÇÃO ---
      function mudarAba(aba) {
        // Atualiza botões
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        if(aba === 'geral') document.getElementById('btnAbaGeral').classList.add('active');
        else document.getElementById('btnAbaDetalhe').classList.add('active');

        // Troca Tela
        document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
        if(aba === 'geral') {
          document.getElementById('telaGeral').classList.add('active');
          setTimeout(() => mapGeral && mapGeral.invalidateSize(), 200); // Fix Leaflet render
        } else {
          document.getElementById('telaDetalhe').classList.add('active');
          setTimeout(() => mapDetalhe && mapDetalhe.invalidateSize(), 200);
        }
      }

      // --- LÓGICA DO MAPA GERAL ---
      function renderizarMapaGeral(dados) {
        // Totais
        document.getElementById('totalQuadrasGeral').innerText = dados.length;
        document.getElementById('totalDomiciliosGeral').innerText = dados.reduce((acc, curr) => acc + curr.total, 0);

        // Inicializa Mapa
        if(!mapGeral) {
          mapGeral = L.map('mapGeral').setView([-7.115, -34.863], 13);
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OSM' }).addTo(mapGeral);
          layerGeral = L.layerGroup().addTo(mapGeral);
        }

        const bounds = [];
        
        dados.forEach(q => {
          if(q.lat && q.lng) {
            // Marcador Azul (Padrão)
            const marker = L.marker([q.lat, q.lng]);
            
            const popupContent = `
              <div class="popup-quadra">
                <h6>${q.id}</h6>
                <p class="m-0">${q.total} Domicílios</p>
                <button class="btn btn-sm btn-primary btn-ver-quadra" onclick="abrirQuadraDoMapa('${q.id}')">
                  Ver Detalhes
                </button>
              </div>
            `;
            
            marker.bindPopup(popupContent);
            layerGeral.addLayer(marker);
            bounds.push([q.lat, q.lng]);
          }
        });

        if(bounds.length > 0) mapGeral.fitBounds(bounds, {padding:[50,50]});
        showLoading(false);
      }

      function abrirQuadraDoMapa(quadraId) {
        // Seleciona no dropdown
        const sel = document.getElementById('selectQuadra');
        sel.value = quadraId;
        
        // Vai para a aba
        mudarAba('detalhe');
        
        // Carrega dados
        carregarQuadra(quadraId);
      }

      // --- LÓGICA DA QUADRA (DETALHES) ---
      function carregarQuadra(quadraId) {
        showLoading(true, "Baixando Quadra " + quadraId);
        document.getElementById('infoArea').style.display = 'none';
        
        google.script.run.withSuccessHandler(renderizarDetalhes).getDadosDaQuadra(quadraId);
      }

      function renderizarDetalhes(dados) {
        const titulo = document.getElementById('selectQuadra').value;
        document.getElementById('tituloQuadra').innerText = titulo;
        
        // Processamento (Agrupamento)
        const grupos = {};
        dados.forEach(d => {
          const chave = `${d.logradouro}_${d.numero}`;
          if (!grupos[chave]) {
            grupos[chave] = {
              logradouro: d.logradouro,
              numero: d.numero,
              lat: d.lat,
              lng: d.lng,
              nomeEdificio: d.nomeEdificio,
              unidades: []
            };
          }
          grupos[chave].unidades.push(d);
        });

        document.getElementById('totalEnderecos').innerText = Object.keys(grupos).length;
        document.getElementById('totalUnidades').innerText = dados.length;

        // Renderiza Mapa Detalhe
        if(!mapDetalhe) {
          mapDetalhe = L.map('mapDetalhe');
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mapDetalhe);
          layerDetalhe = L.layerGroup().addTo(mapDetalhe);
        } else {
          layerDetalhe.clearLayers();
        }

        const bounds = [];
        Object.values(grupos).forEach(g => {
          if(g.lat && g.lng) {
            // Marcador Vermelho para diferenciar
            const redIcon = new L.Icon({
              iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/markers/marker-icon-2x-red.png',
              shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
              iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
            });
            const m = L.marker([g.lat, g.lng], {icon: redIcon});
            let txt = `<b>${g.numero}</b> ${g.logradouro}`;
            if(g.nomeEdificio) txt = `<b>${g.nomeEdificio}</b><br>${g.numero}`;
            m.bindPopup(txt);
            layerDetalhe.addLayer(m);
            bounds.push([g.lat, g.lng]);
          }
        });

        if(bounds.length > 0) mapDetalhe.fitBounds(bounds, {padding:[30,30]});
        else mapDetalhe.setView([-7.115, -34.863], 13); // Fallback

        // Renderiza Lista
        let html = '';
        Object.keys(grupos).forEach((chave, idx) => {
          const p = grupos[chave];
          const qtd = p.unidades.length;
          const isPredio = qtd > 1 || (p.nomeEdificio && p.nomeEdificio.length > 3);
          const idCol = `col-${idx}`;

          let icon = isPredio ? '<i class="fa-solid fa-building text-primary"></i>' : '<i class="fa-solid fa-house text-success"></i>';
          let nomeShow = p.nomeEdificio ? `<span class="nome-predio">${p.nomeEdificio}</span>` : '';
          let badge = qtd > 1 ? `<span class="badge bg-secondary ms-2">${qtd} apts</span>` : '';

          if(isPredio) {
            html += `
              <div class="accordion-item">
                <h2 class="accordion-header">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#${idCol}">
                    <div class="w-100">
                      ${nomeShow}
                      <span>${icon} <span class="numero-destaque">${p.numero}</span> ${p.logradouro} ${badge}</span>
                    </div>
                  </button>
                </h2>
                <div id="${idCol}" class="accordion-collapse collapse">
                  <div class="accordion-body p-0">
                    <ul class="lista-unidades">
                      ${p.unidades.sort((a,b)=> (a.complemento||"").localeCompare(b.complemento||"", undefined, {numeric:true})).map(u => 
                        `<li class="unidade-item">
                           <span>${(u.complemento||"Casa").replace("APARTAMENTO","Apt")}</span>
                           <div class="check-visit" onclick="this.classList.toggle('checked')"></div>
                         </li>`
                      ).join('')}
                    </ul>
                  </div>
                </div>
              </div>`;
          } else {
            // Casa
            html += `
              <div class="accordion-item">
                <div class="accordion-button" style="pointer-events:none; background:white;">
                  <div class="w-100 d-flex justify-content-between align-items-center">
                    <div>
                      ${nomeShow}
                      <span>${icon} <span class="numero-destaque">${p.numero}</span> ${p.logradouro}</span>
                    </div>
                    <div class="check-visit" style="pointer-events:auto;" onclick="this.classList.toggle('checked')"></div>
                  </div>
                </div>
              </div>`;
          }
        });

        document.getElementById('listaEnderecos').innerHTML = html;
        document.getElementById('infoArea').style.display = 'block';
        showLoading(false);
      }
    </script>
  </body>
</html>
